---
title: "Compresión del audio"
author: "Javier Herrero Pérez"
date: "2025-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Compresión del audio


```{r}
# Librerías
library(av)
library(wavelets)
library(tuneR)
library(RColorBrewer)
```



```{r}
# Parámetros
n.levels <- 4
lambda <- 0.2   # sparsity
delta  <- 0.01     # cuantización
audio <- readWave("data/audio.wav")

source("funciones_audio.R",echo=F)

# DWT + threshold
vals <- dwt_values(audio, n.levels, lambda)

# Cuantización
q_left  <- quantize_wt(vals$thr_left,  delta)
q_right <- quantize_wt(vals$thr_right, delta)

# Codificación
enc_left  <- encode_wt(q_left)
enc_right <- encode_wt(q_right)

# Guardar archivo comprimido
size_bytes <- save_compressed(
  "data_comp/audio_wavelet_comp.rds",
  left  = enc_left,
  right = enc_right,
  delta = delta,
  filter = "la8",
  n.levels = n.levels
)

cat("Tamaño del archivo comprimido:", size_bytes, "bytes\n")

```
### Decodificación

```{r}

wt_left_rec <- dequantize_wt(
  decode_wt(enc_left, vals$thr_left),
  delta
)

wt_right_rec <- dequantize_wt(
  decode_wt(enc_right, vals$thr_right),
  delta
)

# Señal final
signal_left_rec  <- idwt(wt_left_rec)
signal_right_rec <- idwt(wt_right_rec)

audio_wav <- Wave(
    left = signal_left_rec,
    right = signal_right_rec,
    samp.rate = audio@samp.rate,
    bit = audio@bit
)
writeWave(audio_wav, "data_comp/audio2comp.wav")


mse_left  <- mean((audio@left  - signal_left_rec)^2)
mse_right <- mean((audio@right - signal_right_rec)^2)

cat("MSE Left :", mse_left, "\n")
cat("MSE Right:", mse_right, "\n")

```
```{r}
plot_heatmap_wavelet_coef(audio,n.levels,lambda,threshold=F)
plot_heatmap_wavelet_coef(audio,n.levels,lambda,threshold=T)
```

```{r}
for (i in 1:n.levels){
  plot_umbralD_energy(audio,n.levels,lambda,i,plot="left",threshold=F)
}
```

```{r}
plot_energy_vs_coeff(audio,n.levels,lambda)
```
```{r}
lambda_vals <- seq(0, 1, by = 0.1)

size_data <- size_vs_lambda(
  audio     = audio,
  n.levels  = n.levels,
  lambda_vals = lambda_vals,
  delta     = delta   # o NULL si no cuantizas
)

plot(
  size_data$lambda,
  size_data$size_bytes / 1000,
  type = "b", pch = 19,
  col = "darkred",
  xlab = expression(lambda),
  ylab = "Tamaño archivo (KB)",
  main = "Tamaño del archivo comprimido vs umbral"
)

grid()

```
```{r}

```

